{% extends 'new_base.html' %}
{% load static %}
{% block body %}
    <div class="container">
        <div class="row">
            <h5>Your Messages</h5>
            <div class="col-md-4">
                <ul class="list-group" id="message-list">
                    {% for thread in threads %}
                        <li class="list-group-item {% if not thread.is_read %}font-weight-bold{% endif %} {% if forloop.first %}active{% endif %}"
                            id="message-{{ thread.id }}"
                            onclick="showMessage({{ thread.id }})">
                            <div class="d-flex justify-content-between">
                                <span>{{ thread.subject }}</span>
                                <span class="">{{ thread.date_sent|date:"M d, Y" }}</span>
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-md-8">
                <div id="message-preview" class="card p-3">
                    {% for thread in threads %}
                        <div id="message-content-{{ thread.id }}" class="message-content"
                             style="display: {% if forloop.first %}block{% else %}none{% endif %};">
                            <h5 class="border-bottom pb-3">{{ thread.subject }}</h5>
                            <div class="message-thread">
                                {% for reply in thread.get_thread.reverse %}
                                    {% if reply.message_type == 'question' %}
                                        <div class="message-reply p-2 my-2 card {% if reply.sender_id == request.user.id %}text-end{% else %}text-start{% endif %}">
                                            <div class="">{{ reply.body }}</div>
                                            <small class="text-muted">{{ reply.sender.username }}
                                                - {{ reply.date_sent }}</small>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                                {% for reply in thread.get_thread %}
                                    {% if reply.message_type != 'question' %}
                                        <div class="message-reply p-2 my-2 card {% if reply.sender_id == request.user.id %}text-end{% else %}text-start{% endif %}">
                                            <div class="">{{ reply.body }}</div>
                                            <small class="text-muted">{{ reply.sender.username }}
                                                - {{ reply.date_sent }}</small>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <form class="submitForm" method="post" action="{% url 'send_reply' thread.id %}">
                                {% csrf_token %}
                                <div class="form-group mt-3 ">
                                    <textarea name="reply" class="form-control" rows="3"
                                              placeholder="Write your reply..." maxlength="1000"></textarea>

                                </div>
                                <div class="d-flex justify-content-between">
                                    <small id="charCount" class="form-text text-muted ps-1">0/1000 characters used</small>
                                    <button type="submit" class="btn btn-primary mt-2">Send Reply</button>
                                </div>
                            </form>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <link href='{% static "css/inbox.css" %}' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        function showMessage(messageId) {
            document.querySelectorAll('.message-content').forEach(function (content) {
                content.style.display = 'none';
            });
            document.querySelectorAll('.list-group-item').forEach(function (item) {
                item.classList.remove('active');
            });
            document.getElementById('message-content-' + messageId).style.display = 'block';
            document.getElementById('message-' + messageId).classList.add('active');
        }


        const textarea = document.querySelector('textarea[name="reply"]');
        const charCount = document.getElementById('charCount');

        textarea.addEventListener('input', function () {
            const currentLength = textarea.value.length;
            charCount.textContent = `${currentLength}/1000 characters used`;
        });

        document.querySelector('.submitForm').addEventListener('submit', function (e) {
            e.preventDefault(); // Prevent the form from submitting immediately

            const messageText = textarea.value;

            // Send the message to the validation endpoint
            fetch(`/message/validate/${encodeURIComponent(messageText)}/`)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    if (data.contains_pii) {
                        // Highlight the PII in the message
                        const highlightedMessage = data.validated_message.replace(/##(.*?)##/g, '<span style="background-color: yellow;">$1</span>').replace(/!!(.*?)!!/g, '<span>$1</span>');

                        // Display the highlighted message in SweetAlert2
                        Swal.fire({
                            title: 'Sensitive Information Detected',
                            html: `In accordance with our terms and conditions, this auction platform is blind, and sharing personally identifiable information (PII) is not permitted. Please review and remove the highlighted information before sending your message: <br><br>${highlightedMessage}`,
                            icon: 'warning',
                            showCancelButton: false,
                            confirmButtonText: 'OK, I will edit it',
                            customClass: {
                                confirmButton: 'btn btn-primary',
                            },

                        }).then((result) => {
                            if (result.isConfirmed) {
                                // If the user chooses to edit, update the textarea with the validated message
                                textarea.value = data.validated_message.replace(/##/g, '').replace(/!!/g, '');
                                charCount.textContent = `${textarea.value.length}/1000 characters used`; // Update the character count
                            }
                        });
                    } else {
                        // No PII detected, submit the form
                        document.querySelector('.submitForm').submit();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    </script>

{% endblock %}
