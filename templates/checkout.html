{% extends 'new_base.html' %}
{% load static %}
{% block title %}Checkout{% endblock %}
{% block body %}
    <div class="container">
        <form method="post">
            {% csrf_token %}

            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs border-0" id="checkoutTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact"
                            type="button" role="tab" aria-controls="contact" aria-selected="true">Contact & Shipping
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="confirmation-tab" data-bs-toggle="tab" data-bs-target="#confirmation"
                            type="button" role="tab" aria-controls="confirmation" aria-selected="false">Order
                        Confirmation
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="payment-tab" data-bs-toggle="tab" data-bs-target="#payment"
                            type="button" role="tab" aria-controls="payment" aria-selected="false">Payment & Submit
                    </button>
                </li>
            </ul>

            <div class="tab-content card " id="checkoutTabContent">
                <!-- Contact & Shipping -->
                <div class="tab-pane fade show active" id="contact" role="tabpanel" aria-labelledby="contact-tab">
                    <div class="card-header">
                        <h3 class="m-0">Order Contact Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3 row align-items-center order-contact-info">
                            <div class="col-2">
                                <label for="id_name">Name</label>
                            </div>
                            <div class="col-4">
                                <input type="text" class="form-control required" id="id_name" name="name"
                                       placeholder="Enter Name"
                                       value="{{ request.user.first_name }} {{ request.user.last_name }} " required>
                            </div>
                        </div>
                        <div class="form-group mb-3 row align-items-center order-contact-info">
                            <div class="col-2">
                                <label for="id_email">Email Address</label>
                            </div>
                            <div class="col-4">
                                <input type="email" class="form-control required" id="id_email" name="email"
                                       placeholder="Enter email"
                                       value="{{ request.user.email }}" required>
                            </div>
                        </div>
                        <div class="form-group  mb-3 row align-items-center order-contact-info">
                            <div class="col-2">
                                <label for="id_phone_number">Phone Number</label>
                            </div>
                            <div class="col-4">
                                <input type="text" class="form-control required" id="id_phone_number"
                                       name="phone_number"
                                       placeholder="Enter phone number" value="{{ request.user.phone_number }}">
                            </div>
                        </div>
                    </div>
                    <div class="card-header border-top">
                        <h3 class="m-0">Shipping & Billing Information</h3>
                    </div>
                    <div class="card-body">
                        <div class="shipping-billing-container">
                            <div class="col pe-5 bs-contact-container">
                                <h4 class="text-muted mt-3">Ship To Contact</h4>
                                <div class="ps-3 bs-contact-container">
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="col-4">
                                            <label for="{{ shipping_form.shipping_full_name.id_for_label }}">Attention</label>
                                        </div>
                                        <div class="col-8">
                                            {{ shipping_form.shipping_full_name }}
                                            {% if shipping_form.shipping_full_name.errors %}
                                                <div class="text-danger">{{ shipping_form.shipping_full_name.errors }}</div>
                                            {% endif %}
                                            
                                        </div>
                                    </div>
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="col-4">
                                            <label for="{{ shipping_form.shipping_phone_number.id_for_label }}">Shipping
                                                Phone</label>
                                        </div>
                                        <div class="col-8">
                                            {{ shipping_form.shipping_phone_number }}
                                            {% if shipping_form.shipping_phone_number.errors %}
                                                <div class="text-danger">{{ shipping_form.shipping_phone_number.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="col-4">
                                            <label for="{{ shipping_form.shipping_email.id_for_label }}">Shipping
                                                Email</label>
                                        </div>
                                        <div class="col-8 d-flex align-items-center">
                                            {{ shipping_form.shipping_email }}
                                            {#                                            <button type="button" class="btn btn-secondary ms-2" id="copyEmailButton">#}
                                            {#                                                Copy Email#}
                                            {#                                            </button>#}
                                            {% if shipping_form.shipping_email.errors %}
                                                <div class="text-danger">{{ shipping_form.shipping_email.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <h4 class="text-muted">Ship To Address</h4>
                                <div class="ps-3 bs-contact-container">
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="col-4">
                                            <label for="{{ shipping_form.shipping_street_address.id_for_label }}">Street
                                                Address
                                                1</label>
                                        </div>
                                        <div class="col-8">
                                            {{ shipping_form.shipping_street_address }}
                                            {% if shipping_form.shipping_street_address.errors %}
                                                <div class="text-danger">{{ shipping_form.shipping_street_address.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="col-4">
                                            <label for="{{ shipping_form.shipping_apartment_suite.id_for_label }}">Street
                                                Address 2</label>
                                        </div>
                                        <div class="col-8">
                                            {{ shipping_form.shipping_apartment_suite }}
                                            {% if shipping_form.shipping_apartment_suite.errors %}
                                                <div class="text-danger">{{ shipping_form.shipping_apartment_suite.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="row p-0 ms-0 city-state-zip-container">
                                            <div class="col-4 filler-column"></div>
                                            <div class="col-8" id="address-container">
                                                <div class="row">
                                                    <div class="col-6 city-col" id="city-col">
                                                        <div class="form-group align-items-center">
                                                            {{ shipping_form.shipping_city }}
                                                            <label class="ps-2"
                                                                   for="{{ shipping_form.shipping_city.id_for_label }}">City</label>
                                                            {% if shipping_form.shipping_city.errors %}
                                                                <div class="text-danger">{{ shipping_form.shipping_city.errors }}</div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-3 state-col" id="state-col">
                                                        <div class="form-group align-items-center">
                                                            {{ shipping_form.shipping_state }}
                                                            <label class="ps-2"
                                                                   for="{{ shipping_form.shipping_state.id_for_label }}">State</label>
                                                            {% if shipping_form.shipping_state.errors %}
                                                                <div class="text-danger">{{ shipping_form.shipping_state.errors }}</div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-3 zip-col" id="zip-col">
                                                        <div class="form-group align-items-center">
                                                            {{ shipping_form.shipping_zip_code }}
                                                            <label class="ps-2"
                                                                   for="{{ shipping_form.shipping_zip_code.id_for_label }}">Zip</label>
                                                            {% if shipping_form.shipping_zip_code.errors %}
                                                                <div class="text-danger">{{ shipping_form.shipping_zip_code.errors }}</div>
                                                            {% endif %}

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="col ps-5 bs-contact-container">
                                <h4 class="text-muted mt-3">Bill To Contact</h4>
                                <div class="ps-3 bs-contact-container">
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="col-4">
                                            <label for="{{ billing_form.billing_full_name.id_for_label }}">Attention</label>
                                        </div>
                                        <div class="col-8">
                                            {{ billing_form.billing_full_name }}
                                            {% if billing_form.billing_full_name.errors %}
                                                <div class="text-danger">{{ billing_form.billing_full_name.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="col-4">
                                            <label for="{{ billing_form.billing_phone_number.id_for_label }}">Billing
                                                Phone</label>
                                        </div>
                                        <div class="col-8">
                                            {{ billing_form.billing_phone_number }}
                                            {% if billing_form.billing_phone_number.errors %}
                                                <div class="text-danger">{{ billing_form.billing_phone_number.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="col-4">
                                            <label for="{{ billing_form.billing_email.id_for_label }}">Billing
                                                Email</label>
                                        </div>
                                        <div class="col-8">
                                            {{ billing_form.billing_email }}
                                            {% if billing_form.billing_email.errors %}
                                                <div class="text-danger">{{ billing_form.billing_email.errors }}</div>
                                            {% endif %}

                                        </div>
                                    </div>
                                </div>
                                <h4 class="text-muted">Bill To Address</h4>
                                <div class="ps-3 bs-contact-container">
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="col-4">
                                            <label for="{{ billing_form.billing_street_address.id_for_label }}">Street
                                                Address
                                                1</label>
                                        </div>
                                        <div class="col-8">
                                            {{ billing_form.billing_street_address }}
                                            {% if billing_form.billing_street_address.errors %}
                                                <div class="text-danger">{{ billing_form.billing_street_address.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="col-4">
                                            <label for="{{ billing_form.billing_apartment_suite.id_for_label }}">Street
                                                Address 2</label>
                                        </div>
                                        <div class="col-8">
                                            {{ billing_form.billing_apartment_suite }}
                                            {% if billing_form.billing_apartment_suite.errors %}
                                                <div class="text-danger">{{ billing_form.billing_apartment_suite.errors }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="form-group mb-3 row align-items-center order-contact-info">
                                        <div class="row p-0 ms-0 city-state-zip-container">
                                            <div class="col-4 filler-column"></div>
                                            <div class="col-8">
                                                <div class="row">
                                                    <div class="col-6 city-col">
                                                        <div class="form-group align-items-center">
                                                            {{ billing_form.billing_city }}
                                                            <label class="ps-2"
                                                                   for="{{ billing_form.billing_city.id_for_label }}">City</label>
                                                            {% if billing_form.billing_city.errors %}
                                                                <div class="text-danger">{{ billing_form.billing_city.errors }}</div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-3 state-col">
                                                        <div class="form-group align-items-center">
                                                            {{ billing_form.billing_state }}
                                                            <label class="ps-2"
                                                                   for="{{ billing_form.billing_state.id_for_label }}">State</label>
                                                            {% if billing_form.billing_state.errors %}
                                                                <div class="text-danger">{{ billing_form.billing_state.errors }}</div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div class="col-3 zip-col">
                                                        <div class="form-group align-items-center">

                                                            {{ billing_form.billing_zip_code }}
                                                            <label class="ps-2"
                                                                   for="{{ billing_form.billing_zip_code.id_for_label }}">Zip</label>

                                                            {% if billing_form.billing_zip_code.errors %}
                                                                <div class="text-danger">{{ billing_form.billing_zip_code.errors }}</div>
                                                            {% endif %}

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-header border-top">
                        <h3 class="m-0">Shipping Method</h3>
                    </div>
                    <div class="card-body p-3">
                        {{ shipping_method_form.as_p }}
                    </div>
                    <div class="card-footer">
                        <button type="button" class="btn btn-primary" id="next-btn-1" data-bs-toggle="tab">Next
                        </button>
                    </div>
                </div>
                <!-- Order Confirmation -->
                <div class="tab-pane fade" id="confirmation" role="tabpanel" aria-labelledby="confirmation-tab">
                    <div class="card-header">
                        <h3 class="m-0">Order Summary</h3>
                    </div>
                    <div class="card-body position-relative">
                        <div class="table p-3">
                            <div class="row fw-bold">
                                <div class="col-6">Item</div>
                                <div class="col-2 text-end">Quantity</div>
                                <div class="col-2 text-end">Price</div>
                                <div class="col-2 text-end">Total</div>
                            </div>
                            {% for item in cart.items.all %}
                                <div class="row">
                                    <div class="col-6">{{ item.auction.title }}</div>
                                    <div class="col-2 text-end">{{ item.quantity }}</div>
                                    <!-- Assuming 'quantity' is a field in CartItem model -->
                                    <div class="col-2 text-end">${{ item.auction.buyItNowPrice }}</div>
                                    <!-- Adjust field name as needed -->
                                    <div class="col-2 text-end">${{ item.total_price }}</div>
                                </div>
                            {% endfor %}

                            <div class="row fw-bold border-top pt-3">
                                <div class="col text-end">Subtotal:</div>
                                <div class="col-1 text-end total-column">${{ cart.total_cost }}</div>
                            </div>
                            <div class="row">
                                <div class="col text-end">Shipping:</div>
                                <div class="col-1 text-end total-column">TBD</div>
                            </div>
                            <div class="row">
                                <div class="col text-end">Taxes:</div>
                                <div class="col-1 text-end total-column">TBD</div>
                            </div>
                            <div class="row fw-bold pt-2">
                                <div class="col"></div>
                                <div class="col-1 border-top text-end total-column">Total:</div>
                                <div class="col-1 border-top text-end total-column">TBD</div>
                            </div>
                        </div>
                        <p class="position-absolute bottom-0 end-0 me-3">Please note: The final total will be provided
                            at the time of order confirmation once shipping
                            has been calculated.</p>
                    </div>

                    <div class="card-footer">
                        <button type="button" class="btn btn-secondary" data-bs-toggle="tab" data-bs-target="#contact">
                            Back
                        </button>
                        <button type="button" class="btn btn-primary" data-bs-toggle="tab" data-bs-target="#payment">
                            Next
                        </button>
                    </div>
                </div>
                <!-- Payment & Submit -->
                <div class="tab-pane fade" id="payment" role="tabpanel" aria-labelledby="payment-tab">
                    <div class="card-header">
                        <h3 class="m-0">Payment Method</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group mb-3">
                            <label for="payment_method">Choose Payment Method</label>
                            <select id="payment_method" class="form-control">
                                <option value="credit-card">Credit Card</option>
                                <option value="ach">ACH</option>
                                <option value="zelle">Zelle</option>
                                <option value="venmo">Venmo</option>
                                <option value="paypal">PayPal</option>
                                <option value="cashapp">CashApp</option>
                            </select>
                        </div>

                        <div id="credit-card-form" class="payment-form">
                            {{ credit_card_form.as_p }}
                        </div>
                        <div id="ach-form" class="payment-form" style="display: none;">
                            <p class="ms-3">ACH instructions will be sent to your email address along with the order
                                confirmation.
                                Please check your inbox for further details on how to complete your payment.</p>

                        </div>
                        <div id="zelle-form" class="payment-form" style="display: none;">
                            {{ zelle_form.as_p }}
                        </div>
                        <div id="venmo-form" class="payment-form" style="display: none;">
                            {{ venmo_form.as_p }}
                        </div>
                        <div id="paypal-form" class="payment-form" style="display: none;">
                            {{ paypal_form.as_p }}
                        </div>
                        <div id="cashapp-form" class="payment-form" style="display: none;">
                            {{ cashapp_form.as_p }}
                        </div>

                        <div class="form-group form-check mt-3 ms-3">
                            <input type="checkbox" class="form-check-input" id="id_agree_terms" required>
                            <label class="form-check-label" for="id_agree_terms">
                                I agree to the
                                <a href="{% url 'terms_and_conditions' %}" target="_blank">Terms and Conditions</a>
                                and
                                <a href="{% url 'privacy_policy' %}" target="_blank">Privacy Policy</a>.
                            </label>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button type="button" class="btn btn-secondary" data-bs-toggle="tab"
                                data-bs-target="#confirmation">Back
                        </button>
                        <button type="submit" class="btn btn-primary">Place Order</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <link href='{% static "css/checkout.css" %}' rel='stylesheet'>
    <script src='{% static "js/checkout.js" %}'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#id_phone_number').mask("(999) 999-9999");
            $('#id_shipping_phone_number').mask("(999) 999-9999");
            $('#id_billing_phone_number').mask("(999) 999-9999");
            $('#id_expiration_date').mask("99/99");

            // Handle tab navigation
            $('#checkoutTabs button').on('click', function () {
                let target = $(this).data('bs-target');
                let tab = new bootstrap.Tab($(target)[0]);
                tab.show();
            });

            // Manually trigger tab change when clicking Next/Back buttons
            $("#next-btn-1").on("click", function () {
                let nextTab = new bootstrap.Tab("#confirmation-tab");
                nextTab.show();
            });

            $("#confirmation .btn-secondary").on("click", function () {
                let prevTab = new bootstrap.Tab("#contact-tab");
                prevTab.show();
            });

            $("#confirmation .btn-primary").on("click", function () {
                let nextTab = new bootstrap.Tab("#payment-tab");
                nextTab.show();
            });

            $("#payment .btn-secondary").on("click", function () {
                let prevTab = new bootstrap.Tab("#confirmation-tab");
                prevTab.show();
            });

            $('#copyEmailButton').click(function () {
                // Get the value from the email input field
                let emailValue = $('#id_email').val();
                // Set the value to the shipping email input field
                $('#id_shipping_email').val(emailValue);
            });
            $('#payment_method').on('change', function () {
                let selectedMethod = $(this).val();
                $('.payment-form').hide();
                $('#' + selectedMethod + '-form').show();
            });


            {#function applyCardMask() {#}
            {#    let cardInput = $('#id_card_number');#}
            {#    let cardValue = cardInput.val();#}
            {##}
            {##}
            {#    if (cardValue.startsWith('3')) {#}
            {#        cardInput.data('mask').remove();#}
            {#        cardInput.unmask().mask("9999-999999-99999");#}
            {#    } else {#}
            {##}
            {#        cardInput.unmask().mask("9999-9999-9999-9999");#}
            {#    }#}
            {#}#}
                {##}
                {#// Apply the mask when the page loads#}
                {#applyCardMask();#}
                {##}
                {#// Apply the mask as the user types#}
                {#$('#id_card_number').on('input', function () {#}
                {#    applyCardMask();#}
                {#})
                    ;
                    #}

                }
            )
                ;
    </script>
    <script>
        $(document).ready(function () {
            function updateRequiredFields() {
                // Clear all required attributes first
                $('#credit-card-form input').removeAttr('required');
                $('#ach-form input').removeAttr('required');
                $('#zelle-form input').removeAttr('required');
                $('#venmo-form input').removeAttr('required');
                $('#paypal-form input').removeAttr('required');
                $('#cashapp-form input').removeAttr('required');

                // Get the selected payment method
                let selectedMethod = $('#payment_method').val();

                // Add required attribute to the relevant fields based on the selected method
                if (selectedMethod === 'credit-card') {
                    $('#credit-card-form input').attr('required', 'required');
                } else if (selectedMethod === 'ach') {
                    $('#ach-form input').attr('required', 'required');
                } else if (selectedMethod === 'zelle') {
                    $('#zelle-form input').attr('required', 'required');
                } else if (selectedMethod === 'venmo') {
                    $('#venmo-form input').attr('required', 'required');
                } else if (selectedMethod === 'paypal') {
                    $('#paypal-form input').attr('required', 'required');
                } else if (selectedMethod === 'cashapp') {
                    $('#cashapp-form input').attr('required', 'required');
                }
            }

            // Update required fields when the payment method changes
            $('#payment_method').on('change', function () {
                updateRequiredFields();
            });

            // Also call the function on page load to set the initial state
            updateRequiredFields();
        });
    </script>

{% endblock %}
